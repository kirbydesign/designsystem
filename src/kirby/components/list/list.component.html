<ion-list kirbyInfiniteScroll
          (scrollEnd)="onLoadOnDemand()"
          [disabled]="!isLoadOnDemandEnabled"
          [class.has-header]="listHeaderTemplate"
          [class.has-footer]="listFooterTemplate">
  <ion-list-header *ngIf="listHeaderTemplate">
    <ng-container *ngTemplateOutlet="listHeaderTemplate"></ng-container>
  </ion-list-header>

  <ng-container *ngIf="isSectionsEnabled; else normalList">
    <ion-item-group *ngFor="let section of groupedItems;trackBy: trackByFn">
      <ion-item-divider class="section-header">
        <ng-container *ngTemplateOutlet="sectionHeaderTemplate; context: { $implicit: section.name }"></ng-container>
      </ion-item-divider>

      <div class="list-items">
        <ion-item *ngFor="let item of section.items; let idx = index;trackBy: trackByFn"
                  [class.has-divider]="showDivider"
                  [class.selectable]="isSelectable"
                  [class.selected]="markSelectedRow && selectedItem && item._id === selectedItem._id"
                  [attr.role]="isSelectable ? 'button' : null"
                  [class.last-in-section]="idx === section.items.length - 1"
                  (click)="onItemSelect(item)"
                  tabindex="0"
                  keyHandler>
          <ng-container *ngTemplateOutlet="listItemTemplate; context: { $implicit: item }"></ng-container>
          <ng-container *ngTemplateOutlet="listFlexItemTemplate; context: { $implicit: item }"></ng-container>
        </ion-item>
      </div>
    </ion-item-group>
  </ng-container>

  <ng-template #normalList>
    <ion-item *ngFor="let item of items;trackBy: trackByFn"
              [class.has-divider]="showDivider"
              [class.selectable]="isSelectable"
              [class.selected]="markSelectedRow && selectedItem && item._id === selectedItem._id"
              [attr.role]="isSelectable ? 'button' : null"
              (click)="onItemSelect(item)"
              tabindex="0"
              keyHandler>
      <ng-container *ngTemplateOutlet="listItemTemplate; context: { $implicit: item }"></ng-container>
      <ng-container *ngTemplateOutlet="listFlexItemTemplate; context: { $implicit: item }"></ng-container>
    </ion-item>
  </ng-template>

  <ion-item *ngIf="isLoading">
    <div class="loading"><kirby-spinner></kirby-spinner></div>
  </ion-item>

  <ion-item *ngIf="!isLoadOnDemandEnabled && noMoreItemsText">
    <p class="no-more-items">{{ noMoreItemsText }}</p>
  </ion-item>

  <div *ngIf="listFooterTemplate" class="footer">
    <ng-container *ngTemplateOutlet="listFooterTemplate"></ng-container>
  </div>
</ion-list>
