@use "sass:color";
@use "sass:map";
@use '~@kirbydesign/core/src/scss/interaction-state';
@use '~@kirbydesign/core/src/scss/utils';

$radio-icon-padding: utils.size('xxxxs');
$radio-icon-size: utils.size('m');
$radio-icon-mark-size: 60%;
$spacing-to-edge: map.get(utils.$checkbox-radio-spacing, 'to-edge');
$spacing-to-label: map.get(utils.$checkbox-radio-spacing, 'to-label');
$default-checkbox-radio-size: map.get(utils.$checkbox-radio-sizes, 'md');

@function getVerticalPadding($target-height) {
  @return ($target-height - $radio-icon-size) * 0.5;
}

// TODO: Move this to a shared location, e.g. in libs/core/src/scss/interaction-state directory
@function _get-hover-color($variant, $loudness: interaction-state.$default-loudness, $flip: false) {
  $_background: utils.get-color($variant, $getValueOnly: true);

  $_lightness: 0% !default;

  @if $flip {
    $_lightness: utils.get-loudness($loudness);
  } @else {
    // negative number means "make it darker"
    $_lightness: -1 * utils.get-loudness($loudness);
  }

  $hover-color: #{color.scale($_background, $lightness: $_lightness)};

  @return $hover-color;
}

:host {
  display: inline-block;

  &.has-label {
    display: block;
    line-height: utils.line-height('n');
    white-space: pre-line;

    div.wrapper {
      position: relative;
      display: inline-flex;
      align-items: flex-start;
      vertical-align: top;
      padding: getVerticalPadding($default-checkbox-radio-size) 0;
      padding-right: $spacing-to-label; // Ensure same padding on right side of label
    }

    @each $size, $height in utils.$checkbox-radio-sizes {
      :host-context(.radio-#{$size}),
      &.#{$size} {
        .wrapper {
          $verticalPadding: getVerticalPadding($height);
          padding-top: $verticalPadding;
          padding-bottom: $verticalPadding;
        }
      }
    }

    ion-radio {
      position: static;
      margin-left: $spacing-to-edge;
      margin-right: $spacing-to-label;
    }
  }

  &[disabled] {
    color: #{utils.get-text-color('semi-dark')};
    ion-radio {
      opacity: 1; // Reset Ionic disabled style
      --color: #{utils.get-color('medium')};
      --color-checked: #{utils.get-color('medium')};
      &::part(container) {
        background-color: utils.get-color('semi-light');
      }
    }
  }
}

ion-radio {
  @include interaction-state.apply-focus-part($part: 'container');

  min-height: $radio-icon-size;
  min-width: $radio-icon-size;
  padding: $radio-icon-padding;
  box-sizing: border-box; // Ensure padding is not added to radio width/height
  --border-width: 1px;
  --color: #{utils.get-color('semi-dark')};
  --color-checked: #{utils.get-color('success')};

  &::part(container) {
    @include interaction-state.transition(background-color);
    background-color: utils.get-color('white');
  }

  @include interaction-state.apply-hover {
    &::part(container) {
      background-color: _get-hover-color('white', $loudness: 's');
    }
  }

  &::part(mark) {
    width: $radio-icon-mark-size;
    height: $radio-icon-mark-size;
  }

  &:active {
    --color: transparent;

    &::part(container) {
      background-color: utils.get-color('white-shade');
    }
  }

  :host-context(kirby-radio-group.error),
  :host-context(kirby-radio-group.ng-touched.ng-invalid) {
    ion-radio,
    ion-radio:active {
      --color: #{utils.get-color('danger')};
    }
  }

  &.radio-checked {
    --border-width: 0px;

    &:not(:focus):not(.radio-disabled) {
      &::part(container) {
        box-shadow: utils.get-elevation(2);
      }
    }
  }
}

:host-context(kirby-item) {
  z-index: utils.z('default'); // Makes whole kirby-item clickable above item-inner.

  ion-radio {
    margin: 0; // Reset Ionic in-item margins
  }

  &[slot='start'] {
    margin-inline-end: $spacing-to-label;
  }
}
