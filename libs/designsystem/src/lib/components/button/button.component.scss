@use "sass:map";
@use '~@kirbydesign/core/src/scss/utils';
@use '~@kirbydesign/core/src/scss/interaction-states' as state;

$button-width: (
  sm: 44px,
  md: 88px,
  lg: 220px,
) !default;

@function button-width($key) {
  @return map.get($button-width, $key);
}

@mixin button-sm {
  font-size: utils.font-size('xs');
  height: utils.size('l');
  min-width: button-width('sm');

  &:not(.icon-only) {
    padding-left: utils.size('s');
    padding-right: utils.size('s');
  }

  &.icon-only {
    width: utils.size('l');
    min-width: unset;
  }

  &.icon-left,
  &.icon-right {
    --kirby-icon-font-size: #{utils.size('s')};
    min-width: button-width('md');
  }
}

@mixin button-lg {
  font-size: utils.font-size('n');
  height: utils.size('xxl');
  min-width: button-width('lg');

  &.icon-only {
    width: utils.size('xxl');
    min-width: unset;
  }
}

@mixin button-no-decoration {
  --kirby-button-background-color: transparent;
  --kirby-button-color: #{utils.get-color('black')};
  --kirby-button-border-color: transparent;

  &.destructive {
    --kirby-button-color: #{utils.get-color('danger')};
  }
}
// TODO: Consider refactoring attentionlevel mixins => pass parameters and reuse (a single mixin)
// First step could be something like:
// @mixin button-attentionlevel1 {
//   $color-variant: 'primary';

//   --kirby-button-background-color: #{utils.get-color('#{$color-variant}')};
//   --kirby-button-color: #{utils.get-color('#{$color-variant}-contrast')};

//   @include state.apply-hover() {
//     --kirby-button-background-color: #{state.get-hover-color('#{$color-variant}', $lightness: -8%)};
//   }

//   &.destructive {
//     --kirby-button-background-color: #{utils.get-color('danger')};
//     --kirby-button-color: #{utils.get-color('danger-contrast')};

//     @include state.apply-hover() {
//       --kirby-button-background-color: #{state.get-hover-color('danger', $lightness: -8%)};
//     }
//   }
// }

@mixin button-attentionlevel1 {
  --kirby-button-background-color: #{utils.get-color('primary')};
  --kirby-button-color: #{utils.get-color('primary-contrast')};

  // ---------------------------------------------------------------------------
  // $_config: (
  //   'color-variant': 'primary-contrast',
  //   'background-color-variant': 'primary',
  //   'property': '--kirby-button-background-color',
  // );

  // @include state.apply-hover-with-params($_config...);
  // ---------------------------------------------------------------------------

  // ---------------------------------------------------------------------------
  @include state.apply-hover(
    $background-color: utils.get-color($variant: 'primary', $getValueOnly: true),
    $color: utils.get-color($variant: 'primary-contrast', $getValueOnly: true),
    $property: '--kirby-button-background-color'
  );
  // ---------------------------------------------------------------------------

  // @include state.apply-hover() {
  //   --kirby-button-background-color: #{state.get-hover-color('primary', $lightness: -8%)};
  // }

  &.destructive {
    --kirby-button-background-color: #{utils.get-color('danger')};
    --kirby-button-color: #{utils.get-color('danger-contrast')};

    // ---------------------------------------------------------------------------
    @include state.apply-hover(
      $background-color: utils.get-color($variant: 'danger', $getValueOnly: true),
      $color: utils.get-color($variant: 'danger-contrast', $getValueOnly: true),
      $property: '--kirby-button-background-color'
    );
    // ---------------------------------------------------------------------------

    // @include state.apply-hover() {
    //   --kirby-button-background-color: #{state.get-hover-color('danger', $lightness: -8%)};
    // }
  }
}

@mixin button-attentionlevel2 {
  --kirby-button-background-color: #{utils.get-color('black')};
  --kirby-button-color: #{utils.get-color('black-contrast')};

  @include state.apply-hover(
    $background-color: utils.get-color($variant: 'white', $getValueOnly: true),
    $color: utils.get-color($variant: 'white-contrast', $getValueOnly: true),
    $property: '--kirby-button-background-color'
  );

  // @include state.apply-hover() {
  //   --kirby-button-background-color: #{state.get-hover-color('white', $lightness: -8%)};
  // }

  &.destructive {
    --kirby-button-background-color: #{utils.get-color('light')};
    --kirby-button-color: #{utils.get-color('danger')};

    // ---------------------------------------------------------------------------
    // $_config: (
    //   'color-variant': 'danger',
    //   'background-color-variant': 'light',
    //   'property': '--kirby-button-background-color',
    // );

    // @include state.apply-hover-with-params($_config...);
    // ---------------------------------------------------------------------------

    @include state.apply-hover(
      $background-color: utils.get-color($variant: 'light', $getValueOnly: true),
      $color: utils.get-color($variant: 'danger', $getValueOnly: true),
      $property: '--kirby-button-background-color'
    );

    // @include state.apply-hover() {
    //   --kirby-button-background-color: #{state.get-hover-color('light', $lightness: -8%)};
    // }
  }
}

@mixin button-attentionlevel3 {
  // Expect canvas underneath to be a light color
  --kirby-button-background-color: transparent;
  --kirby-button-color: #{utils.get-color('black')};
  --kirby-button-border-color: #{utils.get-color('medium')};

  // ---------------------------------------------------------------------------
  // $_config: (
  //   'color-variant': 'black',
  //   'background-color-variant': 'transparent',
  //   // WILL FAIL
  //     'property': '--kirby-button-background-color',
  // );

  // @include state.apply-hover-with-params($_config...);

  // $_config: (
  //   'color':
  //     utils.get-color(
  //       $variant: 'black',
  //       $getValueOnly: true,
  //     ),
  //   'background-color': transparent,
  //   'property': '--kirby-button-background-color',
  // );

  // @include state.apply-hover-with-color-params($_config...);
  @include state.apply-hover(
    $color: utils.get-color($variant: 'black', $getValueOnly: true),
    $background-color: transparent,
    $property: '--kirby-button-background-color'
  );
  // ---------------------------------------------------------------------------

  // @include state.apply-hover() {
  //   --kirby-button-background-color: #{state.get-hover-color('light', $lightness: -4%)};
  // }

  &.destructive {
    --kirby-button-color: #{utils.get-color('danger')};

    @include state.apply-hover(
      $background-color: utils.get-color($variant: 'danger', $getValueOnly: true),
      $color: utils.get-color($variant: 'danger-contrast', $getValueOnly: true),
      $property: '--kirby-button-background-color'
    );
  }
}

:host {
  @include utils.accessible-target-size();

  font-family: var(--kirby-font-family);
  background-color: var(--kirby-button-background-color, initial);
  color: var(--kirby-button-color, inherit);
  border-radius: utils.$border-radius-round;
  box-sizing: border-box; // Ensure border is not added to button height
  cursor: pointer;
  display: inline-flex;
  flex-direction: row;
  align-items: center;
  justify-content: center;
  // TODO: Shouldn't transitions be controlled by design tokens?
  // TODO: Move transition declaration to _hover partial
  transition: background-color 200ms linear;
  // transition: opacity 200ms linear;
  user-select: none;
  vertical-align: middle;
  white-space: nowrap;

  // we default to 'md' size.
  font-size: utils.font-size('s');
  height: utils.size('xl');
  min-width: button-width('md');
  padding: 0 utils.size('m');
  margin: utils.size('xxxs');
  line-height: utils.line-height('s');

  // Outline is applied on button border instead,
  // to keep the rounded shape:
  outline: none;
  border: 1px solid var(--kirby-button-border-color, transparent);

  &.icon-left {
    padding-left: utils.size('xs');
    padding-right: utils.size('s');
    --kirby-icon-margin-right: #{utils.size('xxs')};
  }

  &.icon-right {
    padding-left: utils.size('s');
    padding-right: utils.size('xs');
    --kirby-icon-margin-left: #{utils.size('xxs')};
  }

  &.icon-only {
    width: utils.size('xl');
    padding: 0;
    min-width: unset;
  }

  &.sm {
    @include button-sm;
  }

  &.lg {
    @include button-lg;
  }

  &.no-decoration {
    @include button-no-decoration;
  }

  &.attention-level1 {
    @include button-attentionlevel1;
  }

  &.attention-level2 {
    @include button-attentionlevel2;
  }

  &.attention-level3 {
    @include button-attentionlevel3;
  }

  &[expand='block'] {
    width: 100%;
  }

  // Only apply focus ring if pointer device can hover
  // (effectively desktop/mouse devices):
  @include utils.focus() {
    --kirby-button-border-color: #{utils.$focus-ring-color};
  }

  // TODO: Move to top of :host
  // This is the hover styles that apply in general,
  // ie., when no other hover styles are specified
  // TODO: Decide how to handle default hover styles
  // @include state.apply-hover();

  &:active {
    opacity: 0.8;
  }

  &:disabled {
    background-color: utils.get-color('semi-light');
    color: utils.get-color('semi-dark-shade');
    border-color: transparent;
    pointer-events: none;
  }

  :host-context(.kirby-color-brightness-dark) {
    &.no-decoration {
      --kirby-button-color: #{utils.get-color('white')};
    }

    &.attention-level2 {
      --kirby-button-background-color: #{utils.get-color('white')};
      --kirby-button-color: #{utils.get-color('white-contrast')};

      // ---------------------------------------------------------------------------
      // $_config: (
      //   'color-variant': 'black-contrast',
      //   'background-color-variant': 'black',
      //   'property': '--kirby-button-background-color',
      // );

      // @include state.apply-hover-with-params($_config...);
      // ---------------------------------------------------------------------------
      @include state.apply-hover(
        $background-color: utils.get-color($variant: 'black', $getValueOnly: true),
        $color: utils.get-color($variant: 'black-contrast', $getValueOnly: true),
        $property: '--kirby-button-background-color'
      );
    }

    &.attention-level3 {
      --kirby-button-border-color: #{utils.get-color('white')};
      --kirby-button-color: #{utils.get-color('white')};
    }
  }

  &.floating {
    $fab-size: 64px;
    width: $fab-size !important;
    height: $fab-size !important;
    min-width: unset;

    &:not(:disabled) {
      box-shadow: utils.get-elevation(8);
    }
  }
}

:host-context(kirby-item)[slot='end'] {
  margin-inline-start: utils.size('s');
}

:host-context(kirby-alert).ok-btn {
  --kirby-button-background-color: #{utils.get-color('success')};
  --kirby-button-color: #{utils.get-color('success-contrast')};

  @include state.apply-hover(
    $background-color: utils.get-color($variant: 'success', $getValueOnly: true),
    $color: utils.get-color($variant: 'success-contrast', $getValueOnly: true),
    $property: '--kirby-button-background-color'
  );
}

:host-context(kirby-dropdown) {
  &.attention-level2 {
    --kirby-button-background-color: #{utils.get-color('white')};
    --kirby-button-color: #{utils.get-color('white-contrast')};
  }
}

// Temp fix for https://github.com/angular/angular-cli/issues/13854#issuecomment-470831308
/* clean-css ignore:start */
:host-context(ion-toolbar kirby-page-actions) {
  font-size: utils.font-size('s');
  margin: 0;
  height: utils.$fat-finger-size;

  &.icon-only {
    width: utils.$fat-finger-size;
  }

  &.no-decoration,
  &.attention-level1,
  &.attention-level2,
  &.attention-level3 {
    @include button-no-decoration;
  }
}
/* clean-css ignore:end */

// Temp fix for https://github.com/angular/angular-cli/issues/13854#issuecomment-470831308
/* clean-css ignore:start */
:host-context(.page-title kirby-page-actions) {
  &.no-decoration,
  &.attention-level1,
  &.attention-level2,
  &.attention-level3 {
    @include button-attentionlevel3;
  }
}
/* clean-css ignore:end */

// Temp fix for https://github.com/angular/angular-cli/issues/13854#issuecomment-470831308
/* clean-css ignore:start */
:host-context(kirby-empty-state .content) {
  @include button-lg;
}
/* clean-css ignore:end */

:host-context(kirby-dropdown) {
  justify-content: space-between;
}

:host-context(kirby-toggle-button) {
  @each $color-name, $color-value in utils.$notification-colors {
    &.#{$color-name} {
      --kirby-button-background-color: #{utils.get-color($color-name)};
      --kirby-button-color: #{utils.get-color($color-name + '-contrast')};

      // ---------------------------------------------------------------------------
      // $_config: (
      //   'color-variant': '#{$color-name}-contrast',
      //   'background-color-variant': '#{$color-name}',
      //   'property': '--kirby-button-background-color',
      // );

      // @include state.apply-hover-with-params($_config...);
      // ---------------------------------------------------------------------------

      @include state.apply-hover(
        $background-color: utils.get-color($variant: '#{$color-name}', $getValueOnly: true),
        $color: utils.get-color($variant: '#{$color-name}-contrast', $getValueOnly: true),
        $property: '--kirby-button-background-color'
      );
    }
  }
}
