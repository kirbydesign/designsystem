@use 'sass:color';
@use 'sass:math';
@use 'sass:meta';
@use '../utils';

$default-loudness: utils.get-loudness('quiet');

@mixin apply-hover($background-color, $color, $property, $loudness: $default-loudness) {
  @if meta.type-of($background-color) != color {
    @error "$background-color must be a valid CSS color value. See https://developer.mozilla.org/en-US/docs/Web/CSS/color_value";
  }

  @if meta.type-of($color) != color {
    @error "$color must be a valid CSS color value. See https://developer.mozilla.org/en-US/docs/Web/CSS/color_value";
  }

  @if not(meta.type-of($loudness) == number and math.unit($loudness) == '%') {
    @error "$loudness must be a percentage";
  }

  // ---------------------------------------------------------------------------
  // Determine if lightness should increase or decrease.
  // The default is increase (a positive percentage).
  //
  // When background color is transparent assume that the canvas underneath is
  // a light color. We cannot really determine if lightness should increase or
  // decrease, but this is a best guess. It's possible to work around by passing
  // a $background-color (or $color) parameter with a value other than
  // transparent.
  //
  // Sidenote: The color transparent is defined as black with 0% opacity, i.e.,
  // 100% transparent. Often declared as rgba(0, 0, 0, 0%) in browsers.
  // ---------------------------------------------------------------------------

  $relative-lightness: $loudness !default;

  // TODO: Extract into utility function
  @if color.lightness($background-color) > color.lightness($color) {
    // Make it darker
    $relative-lightness: $relative-lightness * -1;
  }

  $_hover-color: color.scale($background-color, $lightness: $relative-lightness) !default;

  @if color.alpha($background-color) == 0 {
    // $background-color is transparent
    $_hover-color: color.scale(
      $background-color,
      $lightness: $relative-lightness,
      $alpha: $loudness
    );
  }

  cursor: pointer;
  transition-property: all;
  transition-duration: utils.get-transition-duration('quick');
  transition-timing-function: utils.get-transition-easing('static');

  @include utils.hover() {
    #{$property}: #{$_hover-color};

    @content;
  }
}

@mixin apply-hover-layer($loudness: $default-loudness, $flip: false) {
  @if not(meta.type-of($loudness) == number and math.unit($loudness) == '%') {
    @error "$loudness must be a percentage";
  }

  // @include layer($loudness, $flip);
  // @include layer();

  @include utils.hover {
    cursor: pointer;

    --state-layer-opacity: #{$loudness / 100%};

    @if $flip {
      --state-layer-background-color: #fff;
    } @else {
      --state-layer-background-color: #000;
    }

    // DEBUG
    // --state-layer-opacity: 0.7;
    // --state-layer-background-color: crimson;
  }
}

// TODO: Move this mixin to shared interaction state styles
@mixin layer {
  // @mixin layer($loudness: $default-loudness, $flip: false) {
  // @if not(meta.type-of($loudness) == number and math.unit($loudness) == '%') {
  //   @error "$loudness must be a percentage";
  // }

  --state-layer-opacity: 0;
  --state-layer-background-color: transparent;

  position: relative;

  .content {
    position: relative;
    z-index: 2;

    // TODO: These declarations are button specific - move out of generic layer styles. Use Sass @content block?
    // display: inherit;
    // flex-direction: inherit;
    // align-items: inherit;
    // justify-content: inherit;
    // padding-inline: var(--kirby-button-padding-left) var(--kirby-button-padding-right);
  }

  .state-layer {
    position: absolute;
    // TODO: Set inset to 0 (zero) if state layer should not cover border of parent
    inset: calc(var(--border-width, 0px) * -1); // negate border-width on parent
    overflow: hidden;
    pointer-events: none;
    border-radius: inherit;

    z-index: 1;

    &::before {
      content: '';
      position: absolute;
      pointer-events: none;
      inset: -50%;

      // opacity: 0;

      opacity: var(--state-layer-opacity);
      background-color: var(--state-layer-background-color);

      // TODO: Extract transition into "interaction state trasition" mixin
      // transition-property: all;
      // transition-duration: 180ms;
      // transition-delay: 5ms;
      transition-property: all;
      transition-duration: utils.get-transition-duration('quick');
      transition-timing-function: utils.get-transition-easing('static');
    }
  }

  // TODO: This is specific to hover state - move out of generic layer styles
  // @include utils.hover() {
  //   cursor: pointer;

  //   .state-layer::before {
  //     opacity: #{$loudness / 100%};

  //     // TODO: Use CSS custom property instead, e.g. --kirby-button-hover-background-color?
  //     @if $flip {
  //       background-color: #fff;
  //     } @else {
  //       background-color: #000;
  //     }
  //   }
  // }

  // .state-layer::before {
  //   opacity: var(--state-layer-opacity);
  //   background-color: var(--state-layer-background-color);
  // }
}

// TODO: Move this mixin to shared interaction state styles
@mixin content {
  .content {
    @content;
  }
}
